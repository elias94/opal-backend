"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseManifest = void 0;
const query_1 = require("@blackglory/query");
const extra_promise_1 = require("extra-promise");
const iterable_operator_1 = require("iterable-operator/lib/es2015/style/chaining/iterable-operator");
const parse_html_1 = require("./utils/parse-html");
const parse_json_1 = require("./utils/parse-json");
const is_url_1 = require("./utils/is-url");
const combine_relative_urls_1 = require("./utils/combine-relative-urls");
const parse_space_separated_sizes_1 = require("./utils/parse-space-separated-sizes");
const immer_1 = require("./utils/immer");
async function parseManifest(html, textFetcher) {
    const document = parse_html_1.parseHTML(html);
    const manifestUrls = getManifestUrls(document);
    const results = await extra_promise_1.map(manifestUrls, async (url) => {
        const text = await fetch(url);
        if (text) {
            return getManifestIcons(text, url);
        }
        else {
            return [];
        }
    });
    return [].concat(...results);
    async function fetch(url) {
        try {
            return await textFetcher(url);
        }
        catch (_a) {
            return null;
        }
    }
}
exports.parseManifest = parseManifest;
function getManifestUrls(document) {
    const nodes = query_1.query.call(document, query_1.css `link[rel="manifest"]`);
    return new iterable_operator_1.IterableOperator(nodes)
        .map(x => x.getAttribute('href'))
        .filter(is_url_1.isUrl)
        .toArray();
}
function getManifestIcons(json, baseURI) {
    const manifest = parse_json_1.parseJSON(json);
    return manifest.icons
        .map(x => createManifestIcon(x.src, parse_space_separated_sizes_1.parseSpaceSeparatedSizes(x.sizes), x.type))
        .map(combineIconUrlWithManifestUrl);
    function combineIconUrlWithManifestUrl(icon) {
        return immer_1.produce(icon, draft => {
            draft.url = combineRelativeUrlsForManifest(baseURI, icon.url);
        });
    }
    function createManifestIcon(url, sizes, type) {
        return {
            url,
            reference: 'manifest',
            type: type !== null && type !== void 0 ? type : null,
            size: createSize()
        };
        function createSize() {
            if (sizes.length === 0)
                return null;
            if (sizes.length === 1)
                return sizes[0];
            return sizes;
        }
    }
}
function combineRelativeUrlsForManifest(baseURI, relativeUrl) {
    return combine_relative_urls_1.combineRelativeUrls(baseURI, relativeUrl);
}
//# sourceMappingURL=parse-manifest.js.map