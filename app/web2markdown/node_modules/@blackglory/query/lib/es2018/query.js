"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.query = void 0;
const types_1 = require("@blackglory/types");
function query(...selectors) {
    const context = types_1.isDocument(this) ? this : document;
    return pipe([context.documentElement], selectors);
    function pipe(parents, selectors) {
        let lastRoundResults = parents;
        for (const selector of selectors) {
            const results = process(lastRoundResults, selector);
            if (results.size === 0) {
                return [];
            }
            else {
                lastRoundResults = Array.from(results);
            }
        }
        return lastRoundResults;
    }
    function process(parents, selector) {
        const results = new Set();
        if (Array.isArray(selector)) {
            for (const sub of selector) {
                const result = process(parents, sub);
                for (const element of result)
                    results.add(element);
            }
        }
        else {
            for (const parent of parents) {
                const result = Reflect.apply(selector, context, [parent]);
                if (result === null || result === void 0) {
                    continue;
                }
                else if (types_1.isIterable(result)) {
                    for (const element of result)
                        results.add(element);
                }
                else {
                    results.add(result);
                }
            }
        }
        return results;
    }
}
exports.query = query;
//# sourceMappingURL=query.js.map